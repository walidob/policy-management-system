//Generated by AI
using FluentAssertions;
using Microsoft.AspNetCore.Mvc;
using Moq;
using PolicyManagement.Application.Contracts.Identity;
using PolicyManagement.Domain.Entities.DefaultDb.Identity;
using PolicyManagementApp.Api.Controllers;
using Xunit;
using System.Text.Json;

namespace PolicyManagementApp.Api.UnitTests.Controllers;

public class AuthControllerTests
{
    private readonly Mock<IAuthService> _mockAuthService;
    private readonly AuthController _controller;

    public AuthControllerTests()
    {
        _mockAuthService = new Mock<IAuthService>();
        _controller = new AuthController(_mockAuthService.Object);
    }

    [Fact]
    public async Task Login_WithValidCredentials_ReturnsOkObjectResult()
    {
        // Arrange
        var authRequest = new AuthenticationRequest
        {
            Email = "test@example.com",
            Password = "P@ssw0rd"
        };

        var authResponse = new AuthenticationResponse
        {
            Id = 1,
            Username = "testuser",
            Email = "test@example.com",
            FirstName = "Test",
            LastName = "User",
            JwtToken = "test-jwt-token",
            TokenExpires = DateTime.UtcNow.AddHours(1)
        };

        _mockAuthService
            .Setup(s => s.AuthenticateAsync(authRequest))
            .ReturnsAsync(authResponse);

        // Act
        var result = await _controller.Login(authRequest);

        // Assert
        var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
        okResult.Value.Should().BeEquivalentTo(authResponse);
    }

    [Fact]
    public async Task Login_WithInvalidCredentials_ReturnsBadRequest()
    {
        // Arrange
        var authRequest = new AuthenticationRequest
        {
            Email = "test@example.com",
            Password = "wrongpassword"
        };

        _mockAuthService
            .Setup(s => s.AuthenticateAsync(authRequest))
            .ThrowsAsync(new Exception("Authentication failed"));

        // Act
        var result = await _controller.Login(authRequest);

        // Assert
        result.Result.Should().BeOfType<BadRequestObjectResult>();
    }

    [Fact]
    public async Task Logout_ReturnsOkResult()
    {
        // Arrange
        _mockAuthService
            .Setup(s => s.LogoutAsync())
            .Returns(Task.CompletedTask);

        // Act
        var result = await _controller.Logout();

        // Assert
        result.Should().BeOfType<OkObjectResult>();
        var okResult = (OkObjectResult)result;
        
        // Convert the anonymous object to a JsonElement for safe property access
        var json = JsonSerializer.Serialize(okResult.Value);
        var jsonElement = JsonSerializer.Deserialize<JsonElement>(json);
        
        jsonElement.GetProperty("message").GetString().Should().Be("Logged out successfully");
    }
} 